<!DOCTYPE html>

<!--
  ~ The MIT License (MIT)
  ~
  ~ Copyright (c) 2016.  Georg Beier. All rights reserved.
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in all
  ~ copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  ~ SOFTWARE.
  -->

{{define "work_enrol"}}
<form id="enrolform" class="form-horizontal" action="JavaScript:postEnrol()" style="margin: 0;"
      role="form" data-toggle="validator" >
    {{template "csrf" . }}
    <div class="ncontainer" style="padding-right: 15px;">
        {{template "registrationfields" .}}
        <div class="clearfix"></div>
        <h3 class="col-xs-offset-2 col-sm-offset-2 col-lg-offset-1" style="margin-top: 3em;">
            {{i18n "_ok_or_correct" .language}}
        </h3>
        {{template "enrol_fields" .}}
    </div>
    <input type="hidden" name="action" value="enrol">
    <div class="col-xs-11 col-xs-offset-1" style="margin-top: 3em;">
        <button id="change-enrol" type="button" class="btn btn-default">{{i18n "_correct_data" .language}}</button>
        <button id="submit-enrol" type="submit" class="btn btn-primary">{{i18n "_confirm_data" .language}}</button>
    </div>
</form>

<script type="text/javascript">
    // called when this html fragment is loaded,
    // so all element configurations can be done here
    $(document).ready(function () {
        // set action listener functions
        $('#change-enrol').click({b: '#change-enrol', f:'#enrolform'}, enableFormFields);
        // update validator after form load
        $('#enrolform').validator('update')
    });

    // submit the enrol form
    function postEnrol() {
        var formVars = $("#enrolform").serialize();
        postSubmissionAndReload("/enrol/submit", formVars, "/enrol/show", "#enrolarea");
    }

</script>
{{end}}

{{define "enrol_fields"}}
<label class="control-label col-xs-5 col-sm-5 col-md-5 col-lg-3">
    {{i18n "_school" .language}}: {{.school}}
</label>
<label class="checkbox col-xs-3 col-sm-2 col-md-1 col-lg-1">
    <input type="checkbox" name="schoolok" value="ok" required> {{i18n "_correct" .language}}
</label>
<div class="clearfix"></div>
<label class="control-label col-xs-5 col-sm-5 col-md-5 col-lg-3">
    {{i18n "_district" .language}}: {{.districtname}}
</label>
<label class="checkbox col-xs-3 col-sm-2 col-md-1 col-lg-1">
    <input type="checkbox" name="districtok" value="ok" required> {{i18n "_correct" .language}}
</label>
<div class="clearfix"></div>
<label class="control-label col-xs-5 col-sm-5 col-md-5 col-lg-3">
    {{i18n "_ort_exam" .language}}: {{.ort}}, {{.ortmath}}, {{.ortphys}} ({{i18n "_total" .language}},&nbsp;{{i18n "_math" .language}},&nbsp;{{i18n "_physics" .language}})
</label>
<label class="checkbox col-xs-3 col-sm-2 col-md-1 col-lg-1">
    <input type="checkbox" name="ortok" value="ok" required> {{i18n "_correct" .language}}
</label>
<div class="clearfix"></div>
{{end}}

{{define "work_edit"}}
<form id="editform" class="form-horizontal" style="margin: 0;" action="JavaScript:postEdit()">
    {{template "csrf" . }}
    <div class="ncontainer" style="padding-right: 15px;">
        {{template "registrationfields" .}}
    </div>
    <input type="hidden" name="action" value="edit">
    <div class="col-xs-11 col-xs-offset-1" style="margin-top: 3em;">
        <button id="reset-edit" type="reset" class="btn btn-default">Reset</button>
        <button id="submit-edit" type="submit" class="btn btn-primary">Submit</button>
    </div>
</form>

<script type="text/javascript">
    // called when this html fragment is loaded,
    // so all element configurations can be done here
    $(document).ready(function () {
        // update validator after form load
        $('#editform').validator('update')
    });

    function postEdit() {
        var formVars = $("#editform").serialize();
        postSubmissionAndReload("/edit/submit", formVars, "/enrol/show", "#editarea");
    }

</script>
{{end}}

{{define "work_cancellation"}}
<div class="ncontainer" style="padding-right: 15px;">
    {{template "identification" .}}
</div>
<form id="cancellationform" class="form-horizontal" action="JavaScript:postCancellation()" style="margin: 0;"
      role="form" data-toggle="validator" >
    {{template "csrf" . }}
    <input type="hidden" name="appid" value="{{.appid}}">
    <input type="hidden" name="action" value="cancellation">
    <div class="col-xs-11 col-xs-offset-1" style="margin-top: 3em;">
        <button id="submit-cancellation" type="submit" class="btn btn-primary">Absenden</button>
    </div>
</form>
<script type="text/javascript">
    function postCancellation() {
        var formVars = $("#cancellationform").serialize();
        formVars = formVars + '&flag=' + searchFlag;
        $.post("/cancellation/submit", formVars, afterCancellationSubmit);
    }

    function afterCancellationSubmit() {
        var sid = $('#sresult').val();
        var idx = $('#sresult').prop('selectedIndex');
        var csrfid = $("#csrf_id_find").val()
        $('option[value="'+sid+'"]').remove();
        var l = $('#sresult').children('option').length;
        // goto next in list
        if(l > idx) {
            $('#sresult').prop('selectedIndex', idx);
        // else goto prev or empty
        } else {
            $('#sresult').prop('selectedIndex', idx - 1);
        }
        if(l > 0) {
            var selid = $('#sresult').val();
            $("#cancellationarea").load("/cancellation/show", {appid: selid, action: actTab, csrf_token: csrfid,
                flag: actTab == 'cancellation' ? searchFlag : ''});
        } else {
            $('#cancellationarea').html("");
        }
    }
</script>
{{end}}

{{define "identification"}}
<div class="col-xs-6 col-sm-4">
    <label >
        {{i18n "_lastname" .language}}:
    </label> {{.lastname}}
</div>
<div class="col-xs-6 col-sm-4">
    <label >
        {{i18n "_firstname" .language}}:
    </label> {{.firstname}}
</div>
<div class="col-xs-6 col-sm-4">
    <label >
        {{i18n "_fathersname" .language}}:
    </label> {{.fathersname}}
</div>
<div class="clearfix"></div>
<div class="col-xs-12 col-sm-4">
    <label >
        {{i18n "_phone" .language}}:
    </label> {{.phone}}
</div>
<div class="col-xs-12 col-sm-8">
    <label >
        {{i18n "_mail" .language}}:
    </label> {{.email}}
</div>
{{end}}

{{ define "work_edituser" }}

<form  class="form-horizontal" style="margin-right: 0; margin-top: 15px;" type="POST" id="userform" action="Javascript:postUser()">
    {{template "csrf" . }}
    <div class="col-sm-6">
        <div class=" form-group input-group">
            <p id="passmess" style="color: #3c763d">{{i18n "_user_edit_message" .language}}</p>
        </div>
    </div>
    <div class="clearfix"></div>
    <label for="fullname" class="control-label col-xs-4 col-sm-2 col-md-2 col-lg-1">
        {{i18n "_user_fullname" .language}}:
    </label>
    <div class="col-xs-6 col-sm-4 col-sm-push-1 col-md-3 col-lg-2">
        <div class=" form-group input-group">
            <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
            <input class="form-control" name="fullname" id="fullname" value="{{ .fullname }}" type="text" required >
        </div>
    </div>
    <div class="clearfix"></div>
    <label for="login" class="control-label col-xs-4 col-sm-2 col-md-2 col-lg-1">
        {{i18n "_user_login" .language}}:
    </label>
    <div class="col-xs-6 col-sm-4 col-sm-push-1 col-md-3 col-lg-2">
        <div class=" form-group input-group">
            <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
            <input class="form-control" name="login" id="login" value="{{ .login }}" type="text" required >
        </div>
    </div>
    <div class="clearfix"></div>
    <label for="password" class="control-label col-xs-4 col-sm-2 col-md-2 col-lg-1">
        {{i18n "_user_password" .language}}:
    </label>
    <div class="col-xs-6 col-sm-4 col-sm-push-1 col-md-3 col-lg-2">
        <div class=" form-group input-group">
            <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span>
            <input class="form-control" name="password" id="password" type="password" required>
        </div>
    </div>
    <div class="clearfix"></div>
    <label for="verify" class="control-label col-xs-4 col-sm-2 col-md-2 col-lg-1">
        {{i18n "_user_verify" .language}}:
    </label>
    <div class="col-xs-6 col-sm-4 col-sm-push-1 col-md-3 col-lg-2">
        <div class=" form-group input-group">
            <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span>
            <input class="form-control" name="verify" id="verify" type="password" required>
        </div>
    </div>
    <div class="clearfix"></div>

    <script>
        $(document).ready(function () {
            $('#role').val($('#urole').val());
        });

        // submit the enrol form
        function postUser() {
            var formVars = $("#userform").serialize();
            small = false
            big = false
            numb = false
            sim = false
            password = $('#password').val();
            verify = $('#verify').val();
            len = password.length
            for (i = 0; i < len; i++) {
                q = password.charCodeAt(i)
                if (q > 64 && q < 91)big = true
                else if (q > 96 && q < 123)small = true
                else if (q > 47 && q < 58)numb = true
                else sim = true
            }
            if (len > 7 && big && small && numb && sim) {
                if (password == verify) {
                    postSubmissionAndReload("/user/submit", formVars, "/user/show", "#usersarea");
                }
                else {
                    document.getElementById('passmess').style.color = "Red";
                }
            }
            else {
                document.getElementById('passmess').style.color = "Red";
            }

        }

    </script>
    <label for="verify" class="control-label col-xs-4 col-sm-2 col-md-2 col-lg-1">
        {{i18n "_user_role" .language}}:
    </label>
    <div class="col-xs-6 col-sm-4 col-md-3 col-sm-push-1 col-lg-2">
        <div class=" form-group input-group">
            <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span>
                <select id="role" name="role" class="form-control">
                    <option value="255" >Admin</option>
                    <option value="9" >User Admin</option>
                    <option value="7" >Project office member</option>
                    <option value="3" >Student enrolment</option>
                    <option value="1" >ein stino user</option>
                </select>
            </div>
        <input type="text" value="{{ .role }}" id="urole" style="display: none">
        </div>
            <div class="clearfix"></div>
    <div class="col-xs-8 col-xs-offset-4 col-sm-3 col-sm-offset-2 col-sm-push-2 col-md-offset-2 col-lg-offset-1">
        <button id="user_change" type="submit" class="btn btn-primary">{{i18n "_submit" .language}}</button>
    </div>
</form>

{{ end }}

{{ define "work_updated" }}
    <table class="table">
    <thead>
    <tr>
        <th>Lastname</th>
        <th>Firstname</th>
        <th>Fathersname</th>
        <th>LastnameTx</th>
        <th>FirstnameTx</th>
        <th>FathersnameTx</th>
        <th>E-mail</th>
        <th>Phone</th>
        <th>Updater</th>
        <th>Date</th>
    </tr>
    </thead>
        <tbody>
    {{ range $key,$value := .updates }}
    <tr>
        <th>{{ $value.LastName }}</th>
        <th>{{ $value.FirstName }}</th>
        <th>{{ $value.FathersName }}</th>
        <th>{{ $value.LastNameTx }}</th>
        <th>{{ $value.FirstNameTx }}</th>
        <th>{{ $value.FathersNameTx }}</th>
        <th>{{ $value.Email }}</th>
        <th>{{ $value.Phone }}</th>
        <th>{{ $value.UpdatedBy }}</th>
        <th><time>{{ $value.UpdatedAt }}</time></th>
    </tr>

    {{ end }}
        </tbody>
    </table>
{{ end }}


{{ define "adminarea" }}
<script>
    currentyear = (new Date()).getFullYear();
    $("#year option:contains("+currentyear+")").attr('selected', true);
    showMaxValues();

    function showMaxValues() {
        results = $('#year').val();
        l = results.length;
        v = 0;
        counter = 0;
        for (i=0;i<l;i++){
            if(results.charCodeAt(i)==32){
                counter++;
                $("#mr"+counter+"").val(v)
                v = 0;
                continue;
            }
            v=(v*10)+results.charCodeAt(i)-48;
        }
    }

    function editMaxResults(nq) {
        for (i=1;i<=nq;i++) {
            $("#mr"+i+"").prop('readonly',false);
        }
        $('#editMR').hide();
        $('#submitMR').show();
    }

    function submitMaxResults() {
        if (!$('#yearTo').val()) {
            str = $('#year option:selected').text();
            $('#yearTo').val(str);
        }
        $('#examform').submit();
    }

    function addNew(nq) {
        $('#addnewMR').hide();
        $('#droppy').hide();
        $('#forsubyear').show();
        editMaxResults(nq);
    }
</script>
<form role="form" id="examform" method="post" class="form-horizontal" action="submitexamref">
    <div class="col-sm-2">
        <input id="addnewMR" type="button" class="form-control" value="Add new year" onclick="addNew('{{.NQ}}')">
    </div>
    <div class="form-group">

        <div class="clearfix"></div>
        <div class="row">
            <div id="forsubyear" class="col-sm-2" style="display: none">
                <label for="yearTo">Year: </label>
            <input id="yearTo" class="form-control" name="year">
            </div>
            <div class="clearfix"></div>
            <div id="droppy" class="col-sm-2">
                <label for="year">Year: </label>
                <select id="year" class="form-control" onchange="showMaxValues()">
                    {{ range $key,$value := .Examref }}
                    <option value="{{$value.Resultsave}}">{{$value.Year}}</option>
                    {{ end }}
                </select>
                    <br>
                </div>
            </div>
            <br>
            <div id="maxresults">
                {{ range $key,$value := .Rescounter }}
                <div class="form-group">
                <label for="mr{{$value}}" class="col-sm-push-1">{{$value}}:</label>
                    <div class="col-sm-1 col-sm-push-1">
                        <input class="form-control" id="mr{{$value}}" name="mr{{$value}}" readonly>
                    </div>
                </div>
                <div class="clearfix"></div>
                {{ end }}

                </div>
    </div>
</form>


<div id="submitMR" class="col-sm-2" hidden>
    <button class="form-control" onclick="submitMaxResults()">
        Submit
    </button>
</div>

<div id="editMR" class="col-sm-2">
    <button class="form-control" onclick="editMaxResults('{{.NQ}}')">
        Edit
    </button>
</div>


{{ end }}




{{ define "setadminarea" }}

<div class="form-group">
    <div class="col-sm-3">
        <label for="name" class="control-label">
            {{i18n "_user_fullname" .language}}:
        </label>
        <input id="name" class="form-control" value="{{ .user.Fullname }}" readonly>
    </div>
    <div class="clearfix"></div>
    <div class="col-sm-3">
        <label for="user">
            {{i18n "_user_login" .language}}:
        </label>
        <input id="user" class="form-control" value="{{ .user.Login }}" readonly>
    </div>
    <div class="clearfix"></div>
    <div class="clearfix"></div>
    </div>
<div class="radio-inline">
    <label for="changepass" class="control-label">
        <input id="changepass" type="radio" name="updateconf">
        {{i18n "_user_change_password" .language}}
    </label>
</div>
<div class="radio-inline">
    <label for="changename" class="control-label">
        <input id="changename" type="radio" name="updateconf">
        {{i18n "_user_change_fullname" .language}}
    </label>
</div>
<div id="onchangepass" style="display: none">
    <form role="form" onsubmit="return false">
        <div class="form-group">
            <div class="col-sm-3">
                <p id="passmessage" style="color: #3c763d">{{i18n "_user_edit_message" .language}}</p>
            </div>
            <div class="clearfix"></div>
            <div class="col-sm-3">
                <label for="pass">{{i18n "_user_password" .language}}: </label>
                <input class="form-control" type="password" name="password" id="pass">
            </div>
            <div class="clearfix"></div>
            <div class="col-sm-3">
                <label for="verify">{{i18n "_user_verify" .language}}: </label>
                <input class="form-control" type="password" name="verify" id="passverify"><div id="inc"></div>
            </div>
        </div>
        <div class="clearfix"></div>
    </form>
    <div class="col-sm-2">
        <button class="form-control" onclick="submitconfirmation('{{ .user.Password }}','{{ .user.Login }}', true)" >
            {{i18n "_submit" .language}}</button>
    </div>
</div>
<div id="onchangename" style="display: none">
    <form role="form" onsubmit="return false">
        <div class="form-group">
            <div class="col-sm-3">
                <label for="pass">{{i18n "_user_fullname" .language}}: </label>
                <input class="form-control" type="text" name="fullname" id="userfullname" >
            </div>
        </div>
        <div class="clearfix"></div>
    </form>
    <div class="col-sm-2">
        <button class="form-control" onclick="submitconfirmation('{{ .user.Password }}','{{ .user.Login }}', false)" >
            {{i18n "_submit" .language}}</button>
    </div>
</div>

<div id="passcheckform" style="display: none">
<form role="form" onsubmit="return false">
    <div class="form-group">
    <div class="col-sm-3">
        <label for="passcheck">{{i18n "_user_password" .language}}: </label>
        <input class="form-control" type="password" name="password" id="passcheck">
    </div>
        </div>
    <div class="clearfix"></div>
</form>
<div class="col-sm-2">
    <button class="form-control" onclick="subcheckpassword('{{ .user.Password }}','{{ .user.Login }}')">
        {{i18n "_submit" .language}}
    </button>
</div>
</div>

<script>
    checkpass = false;
    var ispass;
    function checkpassword(password,password2,user) {
        return $.ajax({
            type : "get",
            url : "getencryptedpassword",
            data : {"password": password, "user": user, "password2": password2}
        });
    }

    function showpasswordchange() {
        $('#onchangepass').show();
        $('#passcheckform').hide();
        $('#onchangename').hide();
        $('#userfullname').val("");
    }

    function showfullnamechange() {
        $('#onchangename').show();
        $('#passcheckform').hide();
        $('#onchangepass').hide();
        $('#pass').val("");
        $('#passverify').val("");
        document.getElementById('passmessage').style.color = '#3c763d';
    }

    function showpasswordcheck() {
        $('#passcheckform').show();
        $('#onchangepass').hide();
        $('#onchangename').hide();
        $('#userfullname').val("");
    }

    $(document).ready(function () {
        $('#changepass').click(function () {
            if (checkpass) {
                showpasswordchange();
            }
            else {
                showpasswordcheck();
            }
        });
        $('#changename').click(function () {
            showfullnamechange();
        });
    });

    function checkUpdate(login) {
        small = false
        big = false
        numb = false
        sim = false
        password = $('#pass').val();
        verify = $('#passverify').val();
        len = password.length
        for (i=0;i<len;i++){
            q = password.charCodeAt(i)
            if (q>64 && q<91)big = true
            else if (q>96 && q<123)small = true
            else if (q>47 && q<58)numb = true
            else sim = true
        }
        if (len>7 && big && small && numb && sim){
            if (password==verify){
                $.ajax({
                    url: "passupdate",
                    data: {"login": login, "password": password},
                    type: "get",
                    success: function () {
                        document.getElementById('passmessage').innerHTML = "Пароль успешно изменен.";
                        document.getElementById('passmessage').style.color = '#3c763d';
                        $('#pass').val("");
                        $('#passverify').val("");
                        change('none');
                    }
                })

            }
            else {
                document.getElementById('passmessage').style.color = "Red";
            }
        }
        else {
            document.getElementById('passmessage').style.color = "Red";
        }
    }

    function setname(login) {
        var fullname = $('#userfullname').val();
        $.ajax({
            type : "get",
            url : "changefullname",
            data : {"fullname": fullname, "login": login},
            success : function (result) {
                $('#name').val(result);
                $('#userfullname').val("");
            }
        })
    }

    function subcheckpassword(password,user) {
        password2 = $('#passcheck').val();
        checkpassword(password, password2, user).done(
                function (result) {
                    if (result=="match") {
                        showpasswordchange();
                    }
                }
        );
    }

    function submitconfirmation(password, login, ip) {
        ispass = ip;
        $('#confModal').modal("show");
        $('#subconfirm').click(function () {
            password2 = $('#passconfirm').val();
            checkpassword(password,password2,login).done(
                    function (result) {
                        if(result == "match"){
                            if(ispass){checkUpdate(login);}
                            else {
                                alert(ispass);
                                setname(login);
                            }
                            $('#confModal').modal("hide");
                        }
                    }
            );

        });
    }
</script>

<div id="confModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">{{i18n "_user_password" .language}}:</h4>
            </div>
            <div class="modal-body"><input type="password" class="form-control" id="passconfirm"></div>
            <div class="modal-footer">
                <button class="btn btn-default" type="button" id="subconfirm">
                    {{i18n "_submit" .language}}
                </button>
                <button class="btn btn-default" type="button" data-dismiss="modal">
                    {{i18n "_cancel" .language}}
                </button>
            </div>
        </div>
    </div>
</div>
{{ end }}